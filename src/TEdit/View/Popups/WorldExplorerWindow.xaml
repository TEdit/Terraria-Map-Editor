<ui:FluentWindow x:Class="TEdit.View.Popups.WorldExplorerWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
    xmlns:vm="clr-namespace:TEdit.ViewModel"
    xmlns:p="clr-namespace:TEdit.Properties"
    xmlns:cv="clr-namespace:TEdit.Converters"
    Title="{x:Static p:Language.world_explorer_title}"
    WindowStartupLocation="CenterOwner"
    ExtendsContentIntoTitleBar="True"
    WindowBackdropType="Mica"
    Icon="/TEdit;component/Images/tedit.ico"
    Width="850" Height="750"
    MinWidth="600" MinHeight="350">

    <ui:FluentWindow.Resources>
        <cv:BoolToVisibilityConverter x:Key="BoolToVis" />
    </ui:FluentWindow.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <ui:TitleBar Title="{x:Static p:Language.world_explorer_title}" Grid.Row="0"
                     Padding="8,0,0,0" Margin="0"
                     FontSize="12" Height="32"
                     ShowMinimize="False"
                     ShowMaximize="False" />

        <!-- Search + Browse Row -->
        <DockPanel Grid.Row="1" Margin="10,0,10,8">
            <ui:Button DockPanel.Dock="Right" Content="Browse..." Padding="8,4" Margin="8,0,0,0"
                       Click="Browse_Click" />
            <ui:TextBox x:Name="SearchBox"
                        Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                        PlaceholderText="{x:Static p:Language.world_explorer_search_placeholder}"
                        VerticalContentAlignment="Center" />
        </DockPanel>

        <!-- Unified World Grid -->
        <ListView Grid.Row="2" Margin="10,0,10,0"
                  x:Name="WorldListView"
                  ItemsSource="{Binding FilteredWorlds}"
                  SelectedItem="{Binding SelectedWorld}"
                  MouseDoubleClick="WorldList_MouseDoubleClick"
                  SelectionChanged="WorldList_SelectionChanged"
                  ScrollViewer.HorizontalScrollBarVisibility="Disabled">
            <ListView.View>
                <GridView>
                    <GridViewColumn Header="" Width="75">
                        <GridViewColumn.CellTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                    <TextBlock Text="{Binding IsExpanded, Converter={x:Static vm:ExpandIconConverter.Instance}}"
                                               Cursor="Hand" Width="16" FontSize="10"
                                               VerticalAlignment="Center"
                                               MouseDown="ExpandToggle_Click">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding HasBackups}" Value="False">
                                                        <Setter Property="Opacity" Value="0" />
                                                        <Setter Property="IsHitTestVisible" Value="False" />
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>
                                    <Button Click="ToggleFavorite_Click" Tag="{Binding}"
                                            Background="Transparent" BorderThickness="0"
                                            Padding="2" FontSize="14" Cursor="Hand"
                                            ToolTip="Toggle Favorite">
                                        <TextBlock Text="{Binding IsFavorite, Converter={x:Static vm:FavoriteIconConverter.Instance}}"
                                                   FontFamily="Segoe MDL2 Assets" FontSize="14">
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Foreground" Value="{DynamicResource TextFillColorPrimaryBrush}" />
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding IsFavorite}" Value="True">
                                                            <Setter Property="Foreground" Value="Gold" />
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>
                                        <Button.Style>
                                            <Style TargetType="Button">
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding IsMissing}" Value="True">
                                                        <Setter Property="Visibility" Value="Collapsed" />
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Button.Style>
                                    </Button>
                                </StackPanel>
                            </DataTemplate>
                        </GridViewColumn.CellTemplate>
                    </GridViewColumn>
                    <GridViewColumn Header="{x:Static p:Language.world_explorer_col_title}" Width="180">
                        <GridViewColumn.CellTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal">
                                    <!-- Corrupt file indicator -->
                                    <TextBlock Text="&#xE814;" FontFamily="Segoe MDL2 Assets" FontSize="12"
                                               Foreground="#FF4444" VerticalAlignment="Center" Margin="0,0,4,0"
                                               ToolTip="{Binding CorruptReason}"
                                               Visibility="{Binding IsCorrupt, Converter={StaticResource BoolToVis}}" />
                                    <!-- Backup exists indicator -->
                                    <TextBlock Text="&#xE73E;" FontFamily="Segoe MDL2 Assets" FontSize="12"
                                               Foreground="Green" VerticalAlignment="Center" Margin="0,0,4,0"
                                               ToolTip="{x:Static p:Language.world_explorer_backup_exists_tooltip}"
                                               Visibility="{Binding HasAnyBackup, Converter={StaticResource BoolToVis}}" />
                                    <!-- No backup warning -->
                                    <Button Padding="0" Margin="0,0,4,0"
                                            Background="Transparent" BorderThickness="0" Cursor="Hand"
                                            Click="CreateBackup_Click" Tag="{Binding}"
                                            ToolTip="{x:Static p:Language.world_explorer_no_backup_tooltip}">
                                        <Button.Style>
                                            <Style TargetType="Button">
                                                <Setter Property="Visibility" Value="Collapsed" />
                                                <Style.Triggers>
                                                    <MultiDataTrigger>
                                                        <MultiDataTrigger.Conditions>
                                                            <Condition Binding="{Binding HasAnyBackup}" Value="False" />
                                                            <Condition Binding="{Binding IsMissing}" Value="False" />
                                                            <Condition Binding="{Binding IsCorrupt}" Value="False" />
                                                        </MultiDataTrigger.Conditions>
                                                        <Setter Property="Visibility" Value="Visible" />
                                                    </MultiDataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Button.Style>
                                        <TextBlock Text="&#xE7BA;" FontFamily="Segoe MDL2 Assets" FontSize="12" Foreground="#FF8800" />
                                    </Button>
                                    <TextBlock Text="{Binding Title}">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding IsMissing}" Value="True">
                                                        <Setter Property="Foreground" Value="Gray" />
                                                        <Setter Property="TextDecorations" Value="Strikethrough" />
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding IsCorrupt}" Value="True">
                                                        <Setter Property="Foreground" Value="#FF4444" />
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>
                                </StackPanel>
                            </DataTemplate>
                        </GridViewColumn.CellTemplate>
                    </GridViewColumn>
                    <GridViewColumn Header="{x:Static p:Language.world_explorer_col_file}" Width="120"
                                    DisplayMemberBinding="{Binding FileName}" />
                    <GridViewColumn Header="{x:Static p:Language.world_explorer_col_dimensions}" Width="130"
                                    DisplayMemberBinding="{Binding DimensionText}" />
                    <GridViewColumn Header="{x:Static p:Language.world_explorer_col_version}" Width="80"
                                    DisplayMemberBinding="{Binding VersionText}" />
                    <GridViewColumn Header="{x:Static p:Language.world_explorer_col_size}" Width="70"
                                    DisplayMemberBinding="{Binding SizeText}" />
                    <GridViewColumn Header="{x:Static p:Language.world_explorer_col_modified}" Width="90"
                                    DisplayMemberBinding="{Binding LastModifiedText}" />
                    <GridViewColumn Header="" Width="60">
                        <GridViewColumn.CellTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal">
                                    <Button Click="PreviewWorld_Click" Tag="{Binding}"
                                            Background="Transparent" BorderThickness="0"
                                            Padding="2" Cursor="Hand"
                                            ToolTip="{x:Static p:Language.world_explorer_preview_tooltip}">
                                        <TextBlock Text="&#xE7B3;" FontFamily="Segoe MDL2 Assets" FontSize="14"
                                                   Foreground="{DynamicResource TextFillColorPrimaryBrush}" />
                                        <Button.Style>
                                            <Style TargetType="Button">
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding IsMissing}" Value="True">
                                                        <Setter Property="Visibility" Value="Collapsed" />
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Button.Style>
                                    </Button>
                                    <Button Click="OpenFolder_Click" Tag="{Binding}"
                                            Background="Transparent" BorderThickness="0"
                                            Padding="2" Cursor="Hand"
                                            ToolTip="{x:Static p:Language.world_explorer_open_explorer_tooltip}">
                                        <TextBlock Text="&#xE838;" FontFamily="Segoe MDL2 Assets" FontSize="14"
                                                   Foreground="Gold" />
                                        <Button.Style>
                                            <Style TargetType="Button">
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding IsMissing}" Value="True">
                                                        <Setter Property="Visibility" Value="Collapsed" />
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Button.Style>
                                    </Button>
                                </StackPanel>
                            </DataTemplate>
                        </GridViewColumn.CellTemplate>
                    </GridViewColumn>
                </GridView>
            </ListView.View>
            <ListView.ItemContainerStyle>
                <Style TargetType="ListViewItem">
                    <Setter Property="Foreground" Value="{DynamicResource ListViewItemForeground}" />
                    <Setter Property="Background" Value="Transparent" />
                    <Setter Property="Border.CornerRadius" Value="{DynamicResource ControlCornerRadius}" />
                    <Setter Property="BorderThickness" Value="1" />
                    <Setter Property="Padding" Value="6,0,6,0" />
                    <Setter Property="Margin" Value="0,0,0,2" />
                    <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                    <Setter Property="VerticalContentAlignment" Value="Center" />
                    <Setter Property="OverridesDefaultStyle" Value="True" />
                    <Setter Property="MinHeight" Value="{DynamicResource GridViewItemContainerMinHeight}" />
                    <Setter Property="Template">
                        <Setter.Value>
                            <ControlTemplate TargetType="ListViewItem">
                                <Border x:Name="RootBorder"
                                        Background="{TemplateBinding Background}"
                                        BorderBrush="{TemplateBinding BorderBrush}"
                                        BorderThickness="{TemplateBinding BorderThickness}"
                                        CornerRadius="{TemplateBinding Border.CornerRadius}"
                                        SnapsToDevicePixels="True">
                                    <Grid>
                                        <StackPanel>
                                            <GridViewRowPresenter
                                                Margin="{TemplateBinding Padding}"
                                                VerticalAlignment="{TemplateBinding VerticalContentAlignment}"
                                                SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}" />
                                            <ItemsControl ItemsSource="{Binding Backups}"
                                                          Margin="50,0,0,4"
                                                          Visibility="{Binding IsExpanded, Converter={StaticResource BoolToVis}}">
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <Border Margin="0,1" Padding="4,2" Cursor="Hand"
                                                                Background="Transparent" CornerRadius="3"
                                                                PreviewMouseLeftButtonDown="BackupEntry_PreviewMouseDown">
                                                            <StackPanel Orientation="Horizontal">
                                                                <TextBlock Text="{Binding IsAutosave, Converter={x:Static vm:BackupDotConverter.Instance}}"
                                                                           FontSize="10" VerticalAlignment="Center" Margin="0,0,4,0"
                                                                           Foreground="{DynamicResource TextFillColorPrimaryBrush}" />
                                                                <TextBlock Text="{Binding DisplayText}"
                                                                           Foreground="{DynamicResource TextFillColorPrimaryBrush}" />
                                                                <Button Padding="2,0" Margin="4,0,0,0"
                                                                        Background="Transparent" BorderThickness="0" Cursor="Hand"
                                                                        Click="PreviewBackup_Click2" Tag="{Binding}"
                                                                        ToolTip="{x:Static p:Language.world_explorer_preview_backup_tooltip}">
                                                                    <TextBlock Text="&#xE7B3;" FontFamily="Segoe MDL2 Assets" FontSize="11"
                                                                               Foreground="{DynamicResource TextFillColorPrimaryBrush}" />
                                                                </Button>
                                                                <Button Padding="2,0" Margin="4,0,0,0"
                                                                        Background="Transparent" BorderThickness="0" Cursor="Hand"
                                                                        Click="OpenBackupFolder_Click" Tag="{Binding}"
                                                                        ToolTip="{x:Static p:Language.world_explorer_open_explorer_tooltip}">
                                                                    <TextBlock Text="&#xE838;" FontFamily="Segoe MDL2 Assets" FontSize="11"
                                                                               Foreground="Gold" />
                                                                </Button>
                                                                <Button Padding="2,0" Margin="4,0,0,0"
                                                                        Background="Transparent" BorderThickness="0" Cursor="Hand"
                                                                        Click="DeleteBackup_Click2" Tag="{Binding}"
                                                                        ToolTip="{x:Static p:Language.world_explorer_delete_backup_tooltip}">
                                                                    <TextBlock Text="&#xE74D;" FontFamily="Segoe MDL2 Assets" FontSize="11"
                                                                               Foreground="{DynamicResource TextFillColorPrimaryBrush}" />
                                                                </Button>
                                                            </StackPanel>
                                                        </Border>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </StackPanel>
                                        <Rectangle x:Name="ActiveRectangle"
                                                   Width="3" Height="16"
                                                   HorizontalAlignment="Left"
                                                   VerticalAlignment="Center"
                                                   Fill="{DynamicResource ListViewItemPillFillBrush}"
                                                   RadiusX="2" RadiusY="2"
                                                   Visibility="Collapsed" />
                                    </Grid>
                                </Border>
                                <ControlTemplate.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter TargetName="RootBorder" Property="Background"
                                                Value="{DynamicResource ListViewItemBackgroundPointerOver}" />
                                    </Trigger>
                                    <Trigger Property="IsSelected" Value="True">
                                        <Setter TargetName="RootBorder" Property="Background"
                                                Value="{DynamicResource ListViewItemBackgroundPointerOver}" />
                                        <Setter TargetName="ActiveRectangle" Property="Visibility" Value="Visible" />
                                    </Trigger>
                                    <MultiTrigger>
                                        <MultiTrigger.Conditions>
                                            <Condition Property="IsSelected" Value="True" />
                                            <Condition Property="IsMouseOver" Value="True" />
                                        </MultiTrigger.Conditions>
                                        <Setter TargetName="RootBorder" Property="Background"
                                                Value="{DynamicResource ListViewItemBackgroundSelectedPointerOver}" />
                                    </MultiTrigger>
                                    <Trigger Property="IsEnabled" Value="False">
                                        <Setter TargetName="RootBorder" Property="Opacity"
                                                Value="{DynamicResource ListViewItemDisabledThemeOpacity}" />
                                    </Trigger>
                                </ControlTemplate.Triggers>
                            </ControlTemplate>
                        </Setter.Value>
                    </Setter>
                </Style>
            </ListView.ItemContainerStyle>
        </ListView>

        <!-- Button Bar -->
        <DockPanel Grid.Row="3" Margin="10,8,10,10">
            <ui:Button DockPanel.Dock="Left" Content="{x:Static p:Language.menu_file_new}" Width="100" Padding="4"
                       Appearance="Success" Click="NewWorld_Click" />
            <StackPanel DockPanel.Dock="Right" Orientation="Horizontal" HorizontalAlignment="Right">
                <ui:Button Content="{x:Static p:Language.world_explorer_open}" Width="80" Padding="4"
                           Appearance="Primary" Margin="0,0,8,0" Click="Open_Click" />
                <ui:Button Content="{x:Static p:Language.common_refresh}" Width="80" Padding="4"
                           Appearance="Secondary" Click="Refresh_Click" />
            </StackPanel>
        </DockPanel>

        <!-- Preview Panel -->
        <Border Grid.Row="4" Margin="10,8,10,10" Padding="8"
                BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}" BorderThickness="1" CornerRadius="4"
                Background="{DynamicResource ControlFillColorDefaultBrush}"
                Visibility="{Binding ShowPreviewPanel, Converter={StaticResource BoolToVis}}">
            <StackPanel>
                <DockPanel Margin="0,0,0,4">
                    <Button DockPanel.Dock="Right" Content="&#x2715;" Click="ClosePreview_Click"
                            Background="Transparent" BorderThickness="0" Padding="4,0" FontSize="12" Cursor="Hand" />
                    <TextBlock Text="{Binding PreviewTitle, StringFormat='Preview: {0}'}"
                               FontWeight="SemiBold" VerticalAlignment="Center" />
                </DockPanel>
                <TextBlock Text="{x:Static p:Language.world_explorer_loading_preview}" Visibility="{Binding IsPreviewLoading, Converter={StaticResource BoolToVis}}"
                           FontStyle="Italic" Foreground="Gray" HorizontalAlignment="Center" Margin="0,4" />
                <Image Source="{Binding PreviewImage}" Stretch="Uniform"
                       Width="600" Height="200"
                       RenderOptions.BitmapScalingMode="NearestNeighbor"
                       Visibility="{Binding HasPreview, Converter={StaticResource BoolToVis}}" />
            </StackPanel>
        </Border>
    </Grid>
</ui:FluentWindow>
