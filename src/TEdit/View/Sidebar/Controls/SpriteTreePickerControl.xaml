<UserControl x:Class="TEdit.View.Sidebar.Controls.SpriteTreePickerControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
             xmlns:cv="clr-namespace:TEdit.Converters"
             xmlns:shared="clr-namespace:TEdit.ViewModel.Shared"
             xmlns:p="clr-namespace:TEdit.Properties"
             mc:Ignorable="d"
             d:DesignHeight="400" d:DesignWidth="350"
             d:DataContext="{d:DesignInstance Type=shared:SpriteTreePickerViewModel}">
    <UserControl.Resources>
        <cv:TEditColorToMediaColorConverter x:Key="TEditColorToMediaColorConverter" />
        <cv:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter" />
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!-- Search bar with Check/Uncheck All buttons (fixed at top) -->
        <Grid Grid.Row="0" Margin="5">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <ui:TextBox Grid.Column="0"
                        PlaceholderText="{x:Static p:Language.picker_search_sprites_placeholder}"
                        Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                        Margin="0,0,5,0" />

            <ui:Button Grid.Column="1"
                       Content="All"
                       ToolTip="{x:Static p:Language.picker_check_all_tooltip}"
                       Command="{Binding CheckAllCommand}"
                       Visibility="{Binding ShowCheckboxes, Converter={StaticResource BoolToVisibilityConverter}}"
                       Margin="0,0,2,0"
                       Padding="8,4" />

            <ui:Button Grid.Column="2"
                       Content="None"
                       ToolTip="{x:Static p:Language.picker_uncheck_all_tooltip}"
                       Command="{Binding UncheckAllCommand}"
                       Visibility="{Binding ShowCheckboxes, Converter={StaticResource BoolToVisibilityConverter}}"
                       Padding="8,4" />
        </Grid>

        <!-- Virtualized TreeView for sprites (no external ScrollViewer - TreeView handles its own) -->
        <TreeView Grid.Row="1"
                  ItemsSource="{Binding FilteredRootNodesView}"
                  VirtualizingPanel.IsVirtualizing="True"
                  VirtualizingPanel.VirtualizationMode="Recycling"
                  ScrollViewer.VerticalScrollBarVisibility="Auto"
                  ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                  BorderThickness="0"
                  Background="Transparent">
            <TreeView.ItemTemplate>
                <HierarchicalDataTemplate DataType="{x:Type shared:SpriteTreeNodeViewModel}"
                                          ItemsSource="{Binding Children}">
                    <StackPanel Orientation="Horizontal" Margin="2">
                        <CheckBox IsChecked="{Binding IsChecked, Mode=TwoWay}"
                                  Visibility="{Binding DataContext.ShowCheckboxes,
                                               RelativeSource={RelativeSource AncestorType=TreeView},
                                               Converter={StaticResource BoolToVisibilityConverter}}"
                                  VerticalAlignment="Center"
                                  Margin="0,0,4,0" />

                        <!-- Color swatch -->
                        <Border BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}"
                                BorderThickness="1"
                                Margin="0,0,6,0"
                                VerticalAlignment="Center">
                            <Rectangle Height="14" Width="14">
                                <Rectangle.Fill>
                                    <SolidColorBrush Color="{Binding Color,
                                        Converter={StaticResource TEditColorToMediaColorConverter}}" />
                                </Rectangle.Fill>
                            </Rectangle>
                        </Border>

                        <!-- Display text (name or name + UV) -->
                        <TextBlock Text="{Binding DisplayText}"
                                   VerticalAlignment="Center"
                                   Foreground="{DynamicResource TextFillColorPrimaryBrush}" />
                    </StackPanel>
                </HierarchicalDataTemplate>
            </TreeView.ItemTemplate>
            <TreeView.ItemContainerStyle>
                <Style TargetType="TreeViewItem" BasedOn="{StaticResource {x:Type TreeViewItem}}">
                    <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}" />
                    <Setter Property="Padding" Value="2" />
                </Style>
            </TreeView.ItemContainerStyle>
        </TreeView>
    </Grid>
</UserControl>
