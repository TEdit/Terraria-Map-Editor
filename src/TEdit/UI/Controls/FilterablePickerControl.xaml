<UserControl x:Class="TEdit.UI.Controls.FilterablePickerControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
             x:Name="Root"
             Focusable="False"
             IsTabStop="False"
             SnapsToDevicePixels="True">

    <UserControl.Resources>
        <Thickness x:Key="PickerPadding">6,0,6,0</Thickness>
        <Thickness x:Key="PickerChevronMargin">4,0,6,0</Thickness>
        <Thickness x:Key="PickerItemMargin">3,1,3,0</Thickness>
        <Thickness x:Key="PickerItemContentMargin">6,4,6,4</Thickness>

        <!-- Minimal TextBox style: strip all chrome so only the text content remains -->
        <Style x:Key="BareTextBoxStyle" TargetType="{x:Type TextBox}">
            <Setter Property="FocusVisualStyle" Value="{x:Null}" />
            <Setter Property="Validation.ErrorTemplate" Value="{x:Null}" />
            <Setter Property="Foreground" Value="{DynamicResource ComboBoxForeground}" />
            <Setter Property="CaretBrush" Value="{DynamicResource ComboBoxForeground}" />
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="Padding" Value="0" />
            <Setter Property="Margin" Value="0" />
            <Setter Property="VerticalAlignment" Value="Center" />
            <Setter Property="VerticalContentAlignment" Value="Center" />
            <Setter Property="SnapsToDevicePixels" Value="True" />
            <Setter Property="OverridesDefaultStyle" Value="True" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type TextBox}">
                        <ScrollViewer x:Name="PART_ContentHost"
                                      Margin="0" Padding="0"
                                      Focusable="False"
                                      HorizontalScrollBarVisibility="Hidden"
                                      VerticalScrollBarVisibility="Hidden" />
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Item container style matching WPF UI ComboBoxItem -->
        <Style x:Key="PickerItemContainerStyle" TargetType="{x:Type ListBoxItem}">
            <Setter Property="FocusVisualStyle" Value="{DynamicResource DefaultControlFocusVisualStyle}" />
            <Setter Property="Foreground" Value="{DynamicResource ComboBoxForeground}" />
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="Padding" Value="{StaticResource PickerItemContentMargin}" />
            <Setter Property="Cursor" Value="Hand" />
            <Setter Property="Border.CornerRadius" Value="{DynamicResource ControlCornerRadius}" />
            <Setter Property="SnapsToDevicePixels" Value="True" />
            <Setter Property="OverridesDefaultStyle" Value="True" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type ListBoxItem}">
                        <Grid Background="Transparent">
                            <Border x:Name="ContentBorder"
                                    Margin="{StaticResource PickerItemMargin}"
                                    Padding="0"
                                    VerticalAlignment="Stretch"
                                    CornerRadius="{TemplateBinding Border.CornerRadius}"
                                    SnapsToDevicePixels="True">
                                <Grid>
                                    <ContentPresenter x:Name="PART_ContentPresenter"
                                                      Margin="{TemplateBinding Padding}"
                                                      VerticalAlignment="Center" />
                                    <Rectangle x:Name="ActiveRectangle"
                                               Width="3" Height="16"
                                               HorizontalAlignment="Left"
                                               VerticalAlignment="Center"
                                               Fill="{DynamicResource ComboBoxItemPillFillBrush}"
                                               RadiusX="2" RadiusY="2"
                                               Visibility="Collapsed" />
                                </Grid>
                            </Border>
                        </Grid>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="ContentBorder" Property="Background" Value="{DynamicResource ComboBoxItemBackgroundSelected}" />
                            </Trigger>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter TargetName="ActiveRectangle" Property="Visibility" Value="Visible" />
                                <Setter TargetName="PART_ContentPresenter" Property="TextElement.Foreground" Value="{DynamicResource ComboBoxItemForegroundSelected}" />
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Foreground" Value="{DynamicResource ComboBoxForegroundDisabled}" />
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </UserControl.Resources>

    <!-- Outer grid: mimics the ComboBox ContentBorder structure -->
    <Grid x:Name="RootGrid">
        <Border x:Name="ContentBorder"
                Background="{DynamicResource ComboBoxBackground}"
                BorderBrush="{DynamicResource ControlElevationBorderBrush}"
                BorderThickness="1,1,1,1"
                CornerRadius="{DynamicResource ControlCornerRadius}"
                Padding="0"
                SnapsToDevicePixels="True">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <!-- Selected item preview (visible when closed, like ComboBox) -->
                <ContentPresenter x:Name="PART_SelectedPresenter" Grid.Column="0"
                                  Margin="{StaticResource PickerPadding}"
                                  VerticalAlignment="Center"
                                  HorizontalAlignment="Stretch"
                                  IsHitTestVisible="False"
                                  TextElement.Foreground="{DynamicResource ComboBoxForeground}" />

                <!-- Filter TextBox â€” bare template, no chrome (hidden until filtering) -->
                <TextBox x:Name="PART_FilterBox" Grid.Column="0"
                         Margin="{StaticResource PickerPadding}"
                         Style="{StaticResource BareTextBoxStyle}"
                         FontSize="{DynamicResource ControlContentThemeFontSize}"
                         ContextMenu="{DynamicResource DefaultControlContextMenu}"
                         Visibility="Collapsed"
                         KeyDown="FilterBox_KeyDown"
                         GotKeyboardFocus="FilterBox_GotFocus"
                         LostKeyboardFocus="FilterBox_LostFocus"
                         TextChanged="FilterBox_TextChanged" />

                <!-- Placeholder watermark (shown when nothing selected) -->
                <TextBlock x:Name="PART_Placeholder" Grid.Column="0"
                           Margin="6,0,6,0"
                           VerticalAlignment="Center"
                           Foreground="{DynamicResource TextFillColorTertiaryBrush}"
                           FontSize="{DynamicResource ControlContentThemeFontSize}"
                           Text="{Binding Placeholder, ElementName=Root}"
                           IsHitTestVisible="False"
                           Visibility="Collapsed" />

                <!-- Chevron icon (matches ComboBox) -->
                <Grid Grid.Column="1" Margin="{StaticResource PickerChevronMargin}">
                    <ui:SymbolIcon x:Name="ChevronIcon"
                                   VerticalAlignment="Center"
                                   FontSize="11"
                                   Foreground="{DynamicResource ComboBoxDropDownGlyphForeground}"
                                   Symbol="ChevronDown24"
                                   RenderTransformOrigin="0.5,0.5">
                        <ui:SymbolIcon.RenderTransform>
                            <RotateTransform x:Name="ChevronRotate" Angle="0" />
                        </ui:SymbolIcon.RenderTransform>
                    </ui:SymbolIcon>
                </Grid>

                <!-- Invisible toggle button spanning full width (click to open, like ComboBox) -->
                <ToggleButton x:Name="PART_DropDownButton"
                              Grid.Column="0" Grid.ColumnSpan="2"
                              HorizontalAlignment="Stretch"
                              VerticalAlignment="Stretch"
                              Focusable="False"
                              Opacity="0"
                              IsChecked="{Binding IsDropDownOpen, ElementName=Root, Mode=TwoWay}"
                              ClickMode="Press" />
            </Grid>
        </Border>

        <!-- Accent bottom border for focus state -->
        <Border x:Name="AccentBorder"
                HorizontalAlignment="Stretch"
                VerticalAlignment="Stretch"
                BorderBrush="{DynamicResource ComboBoxBorderBrushFocused}"
                BorderThickness="0,0,0,2"
                CornerRadius="{DynamicResource ControlCornerRadius}"
                Visibility="Collapsed" />

        <!-- Dropdown popup -->
        <Popup x:Name="PART_Popup"
               PlacementTarget="{Binding ElementName=ContentBorder}"
               Placement="Bottom"
               StaysOpen="True"
               AllowsTransparency="True"
               PopupAnimation="None"
               Focusable="False"
               VerticalOffset="1"
               Opened="Popup_Opened"
               Closed="Popup_Closed">
            <Border x:Name="DropDownBorder"
                    MinWidth="{Binding ActualWidth, ElementName=ContentBorder}"
                    Padding="0,4,0,6"
                    Background="{DynamicResource ComboBoxDropDownBackground}"
                    BorderBrush="{DynamicResource ComboBoxDropDownBorderBrush}"
                    BorderThickness="1"
                    CornerRadius="{DynamicResource PopupCornerRadius}"
                    SnapsToDevicePixels="True">
                <Border.Effect>
                    <DropShadowEffect BlurRadius="20" Direction="270"
                                      Opacity="0.135" ShadowDepth="10"
                                      Color="#202020" />
                </Border.Effect>
                <ListBox x:Name="PART_ItemsList"
                         VirtualizingPanel.IsVirtualizing="True"
                         VirtualizingPanel.VirtualizationMode="Recycling"
                         VirtualizingPanel.ScrollUnit="Pixel"
                         ScrollViewer.CanContentScroll="True"
                         ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                         ScrollViewer.VerticalScrollBarVisibility="Auto"
                         BorderThickness="0"
                         Background="Transparent"
                         MaxHeight="300"
                         ItemContainerStyle="{StaticResource PickerItemContainerStyle}"
                         SelectionChanged="ItemsList_SelectionChanged"
                         PreviewMouseLeftButtonUp="ItemsList_MouseUp"
                         KeyDown="ItemsList_KeyDown">
                    <ListBox.ItemsPanel>
                        <ItemsPanelTemplate>
                            <VirtualizingStackPanel IsVirtualizing="True"
                                                     VirtualizationMode="Recycling" />
                        </ItemsPanelTemplate>
                    </ListBox.ItemsPanel>
                </ListBox>
            </Border>
        </Popup>
    </Grid>

</UserControl>
